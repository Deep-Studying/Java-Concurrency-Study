# Semaphore
### What is semaphore?

- **`세마포어`**는 공유 자원에 대한 **접근**을 **제어**하기 위해 사용되는 **`신호전달 메커니즘`** 동기화 도구이다.
- **`세마포어`**는 정수형 변수 **S**와 **P**, **`V(Verhogen: increment)`**의 두 가지 **원자적 함수**로 **구성**되어 있다.
- **`V`**는 대기 중인 프로세스를 깨우는 **신호**(**Wake-up**)로 **`Signal 연산`**이라고 한다.
- **`스레드`**가 임계영역에 진입하지 못할 경우 자발적으로 **대기(BLOCK) 상태**에 들어가고 **임계영역**을 빠져나오는 스레드가 **대기상태**의 스레드를 **`실행대기상태`**로 깨워준다.
- **`Java`**는 **`Semaphore`** 구현체를 포함하고 있으므로 직접 **`구현`**할 **필요**는 없다.

### Semaphore 동작 방법

- **`S (정수형 변수)`**
    - **공유 자원의 개수**로서 이 개수 만큼 스레드의 접근이 허용된다.
- **`P 연산 (Wait 연산)`**
    - **S**가 **`1 감소`**
    - 스레드가 임계 구역에 진입하기 전 실행된다.
- **`V 연산 (Signal 연산)`**
    - **S**가 **`1 증가`**
    - **`스레드`**가 임계 구역에서 빠져나올 때 **`실행`**되어 카운트 값을 **1 증가**시킨다.

### Semaphore 유형

**Binary Semaphore**

- 카운트 변수 **`S`**가 **`1`**인 **`이진 세마포어`**와 **`2`** 이상의 양수 값을 가진 **`카운팅 세마포어`**로 구분할 수 있다.
    
    ```java
    public class BinarySemaphore implements Semaphore {
    	private int signal = 1;
    	
    	public synchronized void acquired() {
    		while (this.signal == 0) wait();
    		this.signal = 0;
    	}
    	
    	public synchronized void release() {
    		this.signal = 1;
    		notify();
    	}
    }
    ```
    
- **`세마포어`**를 **뮤텍스**처럼 **락**으로 **사용**하기 위해서는 카운트 변수를 **`1`**로 **설정**하면된다.
- 한 **`스레드`**만이 **세마포어**를 획득할 수 있기 때문에 다른 모든 스레드는 **acquired()** 호출시 **`블록`**된다.

**Counting Semaphore**

- **`카운팅 세마포어`**는 카운트 변수를 설정해서 **`스레드`**가 **공유**할 수 있는 **자원**의 **최대치**를 **한정**한다.
- **`락`**을 획득한 **스레드**와 락을 **`해제`**하는 **스레드**는 다를 수 있고, 스레드 간 락과 락해제를 위한 **신호**를 **전달**하여 **`동기화`**를 **`구현`**한다.

```java
public class CountingSemaphore implements Semaphore {
	private int signal;
	private int permits;
	
	public CountingSemaphore(int permits) {
		this.permits = permits;
		this.signal = permits;
	}
	
	public synchronized void acquired() {
		while(this.signal == 0) wait();
		this.signal--;
	}
	
	public synchronized void release() {
		if (this.signal < permits) {
			this.signal++;
			this.notify();
		}
	}
}
```

### Mutex vs Semaphore

- **`동작 방식`**
    - **뮤텍스**는 **공유 자원**에 대한 접근을 동시에 하나의 **스레드**만 가능하도록 **보장**한다.
    - **`세마포어`**는 카운팅 기법으로 특정 개수의 **스레드**가 동시에 **공유 자원**에 **접근**할 수 있도록 **제어**한다.

- **`소유권`**
    - **`뮤텍스`**는 소유권이 있어서 **락**을 획득한 **스레드**만이 **락**을 **해제**할 수 있다.
    - **`세마포어`**는 소유권이 없으며, **세마포어**를 사용하는 **스레드**들이 모두 **`세마포어`**를 **해제**할 수 있다.

- **`초기값`**
    - **`뮤텍스`**는 기본적으로 잠겨있는 **상태**로 시작하고, 한 스레드가 **뮤텍스**를 **획득**하면 다른 스레드들은 블로킹된다.
    - **`세마포어`**는 초기값을 설정할 수 있으며, 초기값에 따라서 처음부터 **`스레드`**가 **자원**에 접근할 수 있는지 **결정**된다.
- **`사용 목적`**
    - **`뮤텍스`**는 하나의 자원에 하나의 **`스레드`**만 접근하도록 **`보장`**해야 하는 경우에 **사용**된다(상호 배제)
    - **`세마포어`**는 **리소스**의 한정적인 사용을 **제어**하는데 **사용**된다(특정 개수의 **`스레드`**만 동시에 자원에 접근하도록 하고 싶을때)
